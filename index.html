<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.108/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.108/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div id="cesiumContainer"></div>
  <script type="module">
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiOTc3M2FiNS0xZjMyLTQxN2EtYTlhNi0wNWZiNWNkZjM4MjciLCJpZCI6MjUwOTk5LCJpYXQiOjE3MzAwMTc3NTV9.xfkO8Gb-TeAFsw35FQ73O5NMZafbRBhe01soGuJe86g';

    // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
    });

	function setArrowPos(x, y)
	{
		arrow.style.left = x + 'px';
		arrow.style.top = y + 'px';
	}

	function from2DtoCartographicPosition (x, y)
	{
		const screenPosition = new Cesium.Cartesian2(x, y);

		// Pick the position on the ellipsoid corresponding to the screen position
		const ellipsoidPosition = viewer.camera.pickEllipsoid(screenPosition, viewer.scene.globe.ellipsoid);

		if (ellipsoidPosition) {
			// Convert the Cartesian3 ellipsoid position to geographic (latitude, longitude, altitude)
			const cartographicPosition = Cesium.Cartographic.fromCartesian(ellipsoidPosition);

			const latitude = Cesium.Math.toDegrees(cartographicPosition.latitude);
			const longitude = Cesium.Math.toDegrees(cartographicPosition.longitude);
			const altitude = cartographicPosition.height;

			console.log(`Latitude: ${latitude}, Longitude: ${longitude}, Altitude: ${altitude}`);

			return {'latitude' : latitude, 'longitude' : longitude, 'altitude' : altitude};
		} else {
			console.log("The screen position does not map to a point on the ellipsoid.");
		}

		return NaN;
	}

    // Add Cesium OSM Buildings, a global 3D buildings layer.
    const buildingTileset = await Cesium.createOsmBuildingsAsync();
    viewer.scene.primitives.add(buildingTileset);   
	
	const camera = new Cesium.Camera(viewer.scene);
	
	
	// var arrow = document.getElementById('arrow');
	var globe = document.getElementById('globe');
	var cesiumContainer = document.getElementById('cesiumContainer');

	var globeRect = globe.getBoundingClientRect();
	var cesiumContainerRect = cesiumContainer.getBoundingClientRect();
	var xRatio = globeRect.width / cesiumContainerRect.width;
	var yRatio = globeRect.height / cesiumContainerRect.height;
	
	viewer.scene.globe.tileLoadProgressEvent.addEventListener(function(tilesLoading) {
		if (tilesLoading === 0) {
			// get current camera and calc position and set the initial arrow position

			var position = camera.positionCartographic;
			var longitude = Cesium.Math.toDegrees(position.longitude);
			var latitude = Cesium.Math.toDegrees(position.latitude);
			var height = position.height;

			var cartesianPosition = Cesium.Cartesian3.fromDegrees(longitude, latitude, height);

			// Convert world coordinates to screen coordinates
			var screenPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, cartesianPosition); // not working for some reason
			if(screenPosition)
			{
				console.log('Screen X:', screenPosition.x);
				console.log('Screen Y:', screenPosition.y);

				setArrowPos(screenPosition.x / xRatio, screenPosition.y / yRatio);
			}
		}
	});

	var screenSpaceEventHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
	screenSpaceEventHandler.setInputAction(function(event){
		// Get the ray from the screen position
		var ray = viewer.camera.getPickRay(event.position);
    
		// Find the intersection of the ray with the globe
		var intersection = viewer.scene.globe.pick(ray, viewer.scene);
		if (intersection) {
			var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(intersection);
			
			// Get the latitude, longitude, and height
			var longitude = Cesium.Math.toDegrees(cartographic.longitude);
			var latitude = Cesium.Math.toDegrees(cartographic.latitude);
			var height = cartographic.height;
			
			setArrowPos( (( 180 + longitude) / 360) * globeRect.width, ((90 - latitude) / 180) * globeRect.height);

			console.log("Intersection at: ", longitude, latitude, height);
		}
		
	}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
	
	globe.addEventListener('click', function(event){		  
		var x = event.clientX;
		var y = event.clientY;
		
		setArrowPos(x - globeRect.left, y - globeRect.top);
		
		camera.flyTo({
			desttination: from2DtoCartographicPosition((x - globeRect.left) / xRatio, (y - globeRect.right) / yRatio)
		});
		
	});
	
 </script>
 </div>
 <div class="container">
	
    <img id="globe" src="globe.png">
	<img id="arrow" src="arrow.png">
	
</div>
 
</body>
</html>

